<!DOCTYPE html>
<html>
<head>
  <title>PSK/Shift-DC Decoder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      background: #111;
      color: #eee;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin: 10px 0;
    }
    label {
      margin-top: 12px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      font-size: 1em;
      padding: 10px;
      margin-top: 5px;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background: #333;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    textarea {
      resize: vertical;
    }
  </style>
</head>
<body>

<h1>PSK/Shift-DC Decoder</h1>

<label>Select WAV File:</label>
<input type="file" id="fileInput" accept=".wav">

<label>Mode:</label>
<select id="mode">
  <option value="psk">PSK</option>
  <option value="shift-dc">Shift DC</option>
</select>

<label>Sample Rate:</label>
<select id="sampleRate">
  <option value="8000">8000</option>
  <option value="16000">16000</option>
  <option value="22050">22050</option>
  <option value="32000">32000</option>
  <option value="44100" selected>44100</option>
  <option value="48000">48000</option>
  <option value="96000">96000</option>
  <option value="192000">192000</option>
</select>

<label>Stereo:</label>
<select id="stereo">
  <option value="false" selected>Off</option>
  <option value="true">On</option>
</select>

<label>CPM (Characters Per Minute):</label>
<input type="number" id="cpm" value="120" min="1">

<button onclick="decodeAudio()">Decode</button>

<label>Binary Output:</label>
<textarea id="binaryOutput" rows="4" readonly></textarea>

<label>Text Output:</label>
<textarea id="textOutput" rows="4" readonly></textarea>

<script>
function decodeAudio() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files[0]) {
    alert("Please select a WAV file first!");
    return;
  }

  const mode = document.getElementById('mode').value;
  const stereo = document.getElementById('stereo').value === 'true';
  const cpm = parseInt(document.getElementById('cpm').value);
  const sampleRate = parseInt(document.getElementById('sampleRate').value);
  const bitDuration = 60 / (cpm * 8);
  const samplesPerBit = Math.floor(bitDuration * sampleRate);

  const reader = new FileReader();
  reader.onload = function(e) {
    const arrayBuffer = e.target.result;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: sampleRate});
    audioCtx.decodeAudioData(arrayBuffer, function(buffer) {
      const numChannels = buffer.numberOfChannels;
      const left = buffer.getChannelData(0);
      const right = numChannels > 1 ? buffer.getChannelData(1) : null;
      const totalBits = Math.floor(left.length / samplesPerBit);
      let binary = '';

      for (let i = 0; i < totalBits; i++) {
        const start = i * samplesPerBit;
        let sum = 0;

        if (stereo) {
          const isLeft = i % 2 === 0;
          const channel = isLeft ? left : right;
          for (let j = 0; j < samplesPerBit; j++) {
            sum += channel[start + j];
          }
        } else {
          for (let j = 0; j < samplesPerBit; j++) {
            sum += left[start + j];
          }
        }

        const avg = sum / samplesPerBit;
        let bit;
        if (mode === 'psk') {
          bit = avg >= 0 ? '1' : '0';
        } else {
          bit = avg >= 0 ? '1' : '0';
        }

        binary += bit;
      }

      document.getElementById('binaryOutput').value = binary;

      // Convert binary to text
      let text = '';
      for (let i = 0; i < binary.length; i += 8) {
        const byte = binary.substr(i, 8);
        if (byte.length === 8) {
          text += String.fromCharCode(parseInt(byte, 2));
        }
      }

      document.getElementById('textOutput').value = text;
    }, function(err) {
      alert("Error decoding audio: " + err);
    });
  };

  reader.readAsArrayBuffer(fileInput.files[0]);
}
</script>

</body>
</html>
